version: '3'

services:
  # Our FastAPI backend service
  backend:
    build: ./backend  # Tells Docker to build an image from the Dockerfile in the 'backend' folder
    ports:
      - "8000:8000"  # Map port 8000 on our machine to port 8000 in the container
    volumes:
      - ./backend:/app  # Mount our local 'backend' code into the container's '/app' directory
    environment:
      - DATABASE_URL=postgresql+asyncpg://user:password@db/feedbackdb
      - GOOGLE_API_KEY=${GOOGLE_API_KEY} # Pass the API key from our .env file
      - SECRET_KEY=${SECRET_KEY}
      - ACCESS_TOKEN_EXPIRE_MINUTES=${ACCESS_TOKEN_EXPIRE_MINUTES}
      - ADMIN_USERNAME=${ADMIN_USERNAME}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD}
      - ADMIN_FORCE_RESET=${ADMIN_FORCE_RESET}
    depends_on:
      - db  # This service won't start until the 'db' service is ready

  # Frontend (React) dev server
  frontend:
    build: ./frontend
    ports:
      - "3000:3000"
    volumes:
      - ./frontend:/app
      - /app/node_modules
    environment:
      - CHOKIDAR_USEPOLLING=true
      - BACKEND_URL=http://backend:8000
    depends_on:
      - backend

  # Our PostgreSQL database service
  db:
    image: postgres:14-alpine  # Use the official PostgreSQL 14 image
    volumes:
      - postgres_data:/var/lib/postgresql/data/  # Persist database data on our machine
    environment:
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=feedbackdb
    ports:
      - "5432:5432" # Map port 5432 so we can connect to the DB from our machine if needed

volumes:
  postgres_data: # Defines the volume to persist data