# Pull Request Checks

name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  # Quick validation checks
  validate:
    name: Quick Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check for merge conflicts
        run: |
          if git diff --check; then
            echo "âœ… No merge conflicts"
          else
            echo "âŒ Merge conflicts detected"
            exit 1
          fi
      
      - name: Validate Docker Compose
        run: |
          docker-compose config > /dev/null
          echo "âœ… Docker Compose configuration is valid"
      
      - name: Check required files
        run: |
          files=(
            "README.md"
            "docker-compose.yml"
            "backend/requirements.txt"
            "frontend/package.json"
          )
          for file in "${files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âŒ Missing required file: $file"
              exit 1
            fi
          done
          echo "âœ… All required files present"
  
  # Run fast tests
  quick-tests:
    name: Quick Tests
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Run backend quick tests
        working-directory: ./backend
        run: |
          pip install -r requirements.txt
          pytest tests/test_auth.py -v
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Run frontend quick tests
        working-directory: ./frontend
        run: |
          npm ci
          npm test -- --run --reporter=verbose src/tests/App.test.jsx
  
  # PR size check
  pr-size:
    name: PR Size Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Check PR size
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const additions = pr.additions;
            const deletions = pr.deletions;
            const changes = additions + deletions;
            
            console.log(`ðŸ“Š PR Stats: +${additions} -${deletions} (${changes} total)`);
            
            if (changes > 500) {
              core.warning('âš ï¸ Large PR detected (>500 lines). Consider breaking into smaller PRs.');
            } else {
              core.info('âœ… PR size is reasonable');
            }
